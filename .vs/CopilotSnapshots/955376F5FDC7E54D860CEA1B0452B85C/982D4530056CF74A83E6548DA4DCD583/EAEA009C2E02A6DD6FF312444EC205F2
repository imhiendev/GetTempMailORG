using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Net;

namespace GetTempMailORG
{
    public class TempMail : IDisposable
    {
        public string? _baseUrl = "https://web2.temp-mail.org";
        private readonly CustomHttpClient customHttpClient;
        private readonly CustomHttpClient customChromeHttpClient;
        private bool disposed = false;

        public TempMail()
        {
            var uri = new Uri(_baseUrl);
            
            // Primary: Custom Chrome JA3 fingerprint
            customChromeHttpClient = new CustomHttpClient(uri.Host, uri.Port, JA3Fingerprint.CustomChrome);
            
            // Fallback: Default Chrome JA3 fingerprint
            customHttpClient = new CustomHttpClient(uri.Host, uri.Port, JA3Fingerprint.Default);
            
            Console.WriteLine($"🔐 Custom Chrome JA3: {JA3Fingerprint.CustomChrome.GenerateJA3String()}");
            Console.WriteLine($"🔐 Default JA3: {JA3Fingerprint.Default.GenerateJA3String()}");
            Console.WriteLine($"📊 Custom Chrome JA3 Info: {JA3Fingerprint.CustomChrome.GetDisplayInfo()}");
        }

        public async Task<Mail?> GetMailAsync()
        {
            var attempts = new List<Func<Task<Mail?>>>
            {
                () => TryCustomChromeHttpClientApproach(),
                () => TryCustomHttpClientApproach()
            };

            foreach (var attempt in attempts)
            {
                try
                {
                    var result = await attempt();
                    if (result != null)
                    {
                        Console.WriteLine($"✅ Success with approach: {attempt.Method.Name}");
                        return result;
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"❌ {attempt.Method.Name} failed: {ex.Message}");
                }
                
                await Task.Delay(2000);
            }

            return null;
        }

        private async Task<Mail?> TryCustomChromeHttpClientApproach()
        {
            Console.WriteLine("🎯 Trying Custom Chrome JA3 Fingerprinting (HTTP/1.1 Only)...");
            
            try
            {
                var request = new HttpRequestMessage(HttpMethod.Post, $"{_baseUrl}/mailbox");
                
                // Add Chrome headers for HTTP/1.1 (no HTTP/2 triggering headers)
                request.Headers.Add("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36");
                request.Headers.Add("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7");
                request.Headers.Add("Accept-Language", "en-US,en;q=0.9");
                request.Headers.Add("Accept-Encoding", "gzip, deflate"); // Remove 'br' to avoid Brotli which can trigger HTTP/2
                request.Headers.Add("DNT", "1");
                // Remove Connection header - will be set in CustomHttpClient
                // Remove Upgrade-Insecure-Requests which can trigger HTTP/2
                request.Headers.Add("Sec-Fetch-Dest", "document");
                request.Headers.Add("Sec-Fetch-Mode", "navigate");
                request.Headers.Add("Sec-Fetch-Site", "none");
                request.Headers.Add("Sec-Fetch-User", "?1");
                request.Headers.Add("sec-ch-ua", "\"Not_A Brand\";v=\"8\", \"Chromium\";v=\"120\", \"Google Chrome\";v=\"120\"");
                request.Headers.Add("sec-ch-ua-mobile", "?0");
                request.Headers.Add("sec-ch-ua-platform", "\"Windows\"");
                request.Headers.Add("Cache-Control", "no-cache");
                request.Headers.Add("Pragma", "no-cache");
                
                // Add form content
                request.Content = new FormUrlEncodedContent(new Dictionary<string, string>());
                
                // Send request with timeout
                var response = await customChromeHttpClient.SendAsync(request, TimeSpan.FromSeconds(45));
                
                Console.WriteLine($"Custom Chrome JA3 status: {response.StatusCode}");
                
                if (response.IsSuccessStatusCode)
                {
                    string html = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"Response length: {html.Length}");
                    
                    return ExtractMailData(html, "CustomChromeJA3");
                }
                else
                {
                    string errorContent = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"Error response: {errorContent.Substring(0, Math.Min(200, errorContent.Length))}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Custom Chrome JA3 error: {ex.Message}");
                if (ex.InnerException != null)
                {
                    Console.WriteLine($"Inner exception: {ex.InnerException.Message}");
                }
                throw;
            }
            
            return null;
        }

        private async Task<Mail?> TryCustomHttpClientApproach()
        {
            Console.WriteLine("🔐 Trying Default JA3 Fingerprinting (HTTP/1.1 Only)...");
            
            try
            {
                var request = new HttpRequestMessage(HttpMethod.Post, $"{_baseUrl}/mailbox");
                
                // Add simplified Chrome headers for HTTP/1.1
                request.Headers.Add("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36");
                request.Headers.Add("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8");
                request.Headers.Add("Accept-Language", "en-US,en;q=0.9");
                request.Headers.Add("Accept-Encoding", "gzip, deflate"); // Remove 'br'
                request.Headers.Add("DNT", "1");
                // Remove Connection and Upgrade headers
                request.Headers.Add("Sec-Fetch-Dest", "document");
                request.Headers.Add("Sec-Fetch-Mode", "navigate");
                request.Headers.Add("Sec-Fetch-Site", "none");
                request.Headers.Add("Sec-Fetch-User", "?1");
                request.Headers.Add("sec-ch-ua", "\"Not_A Brand\";v=\"8\", \"Chromium\";v=\"120\", \"Google Chrome\";v=\"120\"");
                request.Headers.Add("sec-ch-ua-mobile", "?0");
                request.Headers.Add("sec-ch-ua-platform", "\"Windows\"");
                
                // Add form content
                request.Content = new FormUrlEncodedContent(new Dictionary<string, string>());
                
                // Send request with timeout
                var response = await customHttpClient.SendAsync(request, TimeSpan.FromSeconds(45));
                
                Console.WriteLine($"Default JA3 status: {response.StatusCode}");
                
                if (response.IsSuccessStatusCode)
                {
                    string html = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"Response length: {html.Length}");
                    
                    return ExtractMailData(html, "DefaultJA3");
                }
                else
                {
                    string errorContent = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"Error response: {errorContent.Substring(0, Math.Min(200, errorContent.Length))}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Default JA3 error: {ex.Message}");
                if (ex.InnerException != null)
                {
                    Console.WriteLine($"Inner exception: {ex.InnerException.Message}");
                }
                throw;
            }
            
            return null;
        }

        private Mail? ExtractMailData(string html, string approach)
        {
            try
            {
                Console.WriteLine($"[{approach}] Response length: {html.Length}");
                if (html.Length > 0)
                {
                    Console.WriteLine($"[{approach}] First 300 chars: {html.Substring(0, Math.Min(300, html.Length))}");
                }
                
                var patterns = new[]
                {
                    new { TokenPattern = "\"token\":\"(.*?)\"", EmailPattern = "\"mailbox\":\"(.*?)\"" },
                    new { TokenPattern = @"token['"":]\s*['""]([^'""]+)['""]", EmailPattern = @"mailbox['"":]\s*['""]([^'""]+)['""]" },
                    new { TokenPattern = @"data-token=['""]([^'""]+)['""]", EmailPattern = @"data-email=['""]([^'""]+)['""]" },
                    new { TokenPattern = @"window\.token\s*=\s*['""]([^'""]+)['""]", EmailPattern = @"window\.email\s*=\s*['""]([^'""]+)['""]" },
                    new { TokenPattern = @"var\s+token\s*=\s*['""]([^'""]+)['""]", EmailPattern = @"var\s+email\s*=\s*['""]([^'""]+)['""]" }
                };

                foreach (var pattern in patterns)
                {
                    string token = Regex.Match(html, pattern.TokenPattern, RegexOptions.IgnoreCase).Groups[1].Value;
                    string email = Regex.Match(html, pattern.EmailPattern, RegexOptions.IgnoreCase).Groups[1].Value;
                    
                    if (!string.IsNullOrEmpty(token) && !string.IsNullOrEmpty(email))
                    {
                        Console.WriteLine($"[{approach}] ✅ Token: {token}");
                        Console.WriteLine($"[{approach}] ✅ Email: {email}");
                        return new Mail { Token = token, Email = email };
                    }
                }
                
                Console.WriteLine($"[{approach}] ❌ No token/email found with any pattern");
                
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[{approach}] Error extracting data: {ex.Message}");
            }
            return null;
        }

        public async Task<string?> GetOTPAsync(string _token)
        {
            if (string.IsNullOrEmpty(_token))
                return null;
                
            Console.WriteLine("📧 Getting OTP...");
            
            // Try with Custom Chrome JA3 first
            try
            {
                Console.WriteLine("🎯 Using Custom Chrome JA3 for OTP...");
                
                var request = new HttpRequestMessage(HttpMethod.Get, $"{_baseUrl}/messages");
                request.Headers.Add("Authorization", $"Bearer {_token}");
                request.Headers.Add("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36");
                request.Headers.Add("Accept", "*/*");
                request.Headers.Add("Accept-Language", "en-US,en;q=0.9");
                request.Headers.Add("Accept-Encoding", "gzip, deflate");
                request.Headers.Add("DNT", "1");
                request.Headers.Add("sec-ch-ua", "\"Not_A Brand\";v=\"8\", \"Chromium\";v=\"120\", \"Google Chrome\";v=\"120\"");
                request.Headers.Add("sec-ch-ua-mobile", "?0");
                request.Headers.Add("sec-ch-ua-platform", "\"Windows\"");
                
                for (int i = 0; i < 15; i++)
                {
                    Console.WriteLine($"Custom Chrome JA3 OTP attempt {i + 1}/15...");
                    await Task.Delay(4000);
                    
                    var response = await customChromeHttpClient.SendAsync(request, TimeSpan.FromSeconds(30));
                    
                    if (response.IsSuccessStatusCode)
                    {
                        string content = await response.Content.ReadAsStringAsync();
                        Console.WriteLine($"Messages response length: {content.Length}");
                        
                        string? otp = ExtractOTP(content);
                        if (!string.IsNullOrEmpty(otp))
                        {
                            Console.WriteLine($"✅ OTP found with Custom Chrome JA3: {otp}");
                            return otp;
                        }
                    }
                    else
                    {
                        Console.WriteLine($"Messages API error: {response.StatusCode}");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Custom Chrome JA3 OTP failed: {ex.Message}");
            }

            // Try with Default JA3 as fallback
            try
            {
                Console.WriteLine("🔐 Using Default JA3 for OTP (Fallback)...");
                
                var request = new HttpRequestMessage(HttpMethod.Get, $"{_baseUrl}/messages");
                request.Headers.Add("Authorization", $"Bearer {_token}");
                request.Headers.Add("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36");
                request.Headers.Add("Accept", "*/*");
                
                for (int i = 0; i < 10; i++)
                {
                    Console.WriteLine($"Default JA3 OTP attempt {i + 1}/10...");
                    await Task.Delay(5000);
                    
                    var response = await customHttpClient.SendAsync(request, TimeSpan.FromSeconds(30));
                    
                    if (response.IsSuccessStatusCode)
                    {
                        string content = await response.Content.ReadAsStringAsync();
                        
                        string? otp = ExtractOTP(content);
                        if (!string.IsNullOrEmpty(otp))
                        {
                            Console.WriteLine($"✅ OTP found with Default JA3: {otp}");
                            return otp;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Default JA3 OTP failed: {ex.Message}");
            }

            Console.WriteLine("❌ No OTP received after all attempts");
            return null;
        }

        private string? ExtractOTP(string content)
        {
            string[] otpPatterns = {
                @"Your OTP is:?\s*(\d{4,8})",
                @"OTP[:\s]*(\d{4,8})",
                @"verification code[:\s]*(\d{4,8})",
                @"code[:\s]*(\d{4,8})",
                @"(\d{6})", // 6-digit OTP
                @"(\d{4})", // 4-digit OTP
                @">(\d{4,8})<", // OTP in tags
                @"<code>(\d{4,8})</code>"
            };
            
            foreach (var pattern in otpPatterns)
            {
                var matches = Regex.Matches(content, pattern, RegexOptions.IgnoreCase);
                foreach (Match match in matches)
                {
                    string otp = match.Groups[1].Value;
                    if (!string.IsNullOrEmpty(otp) && otp.Length >= 4 && otp.Length <= 8)
                    {
                        return otp;
                    }
                }
            }
            
            return null;
        }

        // Synchronous wrapper methods
        public Mail? GetMail()
        {
            return GetMailAsync().GetAwaiter().GetResult();
        }

        public string? GetOTP(string _token)
        {
            return GetOTPAsync(_token).GetAwaiter().GetResult();
        }

        public void Dispose()
        {
            Dispose(true);
            GC.SuppressFinalize(this);
        }

        protected virtual void Dispose(bool disposing)
        {
            if (!disposed)
            {
                if (disposing)
                {
                    customHttpClient?.Dispose();
                    customChromeHttpClient?.Dispose();
                }
                disposed = true;
            }
        }

        public class Mail
        {
            public string? Token { get; set; }
            public string? Email { get; set; }
        }
    }}}